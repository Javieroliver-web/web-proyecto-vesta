<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Mis Datos - Vesta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <style>
        :root { --vesta-gold: #f1a61c; --vesta-navy: #282c3f; }
        body { background: #f8f9fa; }
        .navbar-vesta { background: linear-gradient(135deg, var(--vesta-navy) 0%, #3c425e 100%); padding: 1rem 0; box-shadow: 0 2px 12px rgba(0,0,0,0.1); }
        .navbar-brand { color: var(--vesta-gold) !important; font-weight: 700; font-size: 1.5rem; }
        .action-card { background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.3s ease; }
        .action-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
        .btn-action { background: linear-gradient(135deg, var(--vesta-gold) 0%, #f4b94c 100%); border: none; color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 8px; }
    </style>
</head>
<body>
    <div th:replace="~{fragments/cookie-banner :: cookie-banner}"></div>

    <nav class="navbar navbar-expand-lg navbar-vesta">
        <div class="container">
            <a class="navbar-brand" href="/cliente/dashboard">
                <i class="bi bi-shield-check"></i> VESTA
            </a>
            <span class="text-white">Hola, <strong th:text="${nombreUsuario}">Usuario</strong></span>
        </div>
    </nav>

    <div class="container py-5">
        <h2 class="fw-bold mb-4">
            <i class="bi bi-person-lock" style="color: var(--vesta-gold);"></i>
            Gesti贸n de Datos Personales
        </h2>

        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>Tus derechos bajo el RGPD:</strong> Aqu铆 puedes ejercer tus derechos de acceso, rectificaci贸n, supresi贸n, portabilidad y oposici贸n seg煤n los art铆culos 15-22 del RGPD.
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="action-card">
                    <h5 class="fw-bold mb-2">
                        <i class="bi bi-eye" style="color: var(--vesta-gold);"></i>
                        Derecho de Acceso
                    </h5>
                    <p class="text-muted small">Consulta qu茅 datos personales tuyos almacenamos (Art. 15 RGPD)</p>
                    <button class="btn btn-action btn-sm" onclick="solicitarAcceso()">Solicitar Acceso</button>
                </div>
            </div>

            <div class="col-md-6">
                <div class="action-card">
                    <h5 class="fw-bold mb-2">
                        <i class="bi bi-pencil" style="color: var(--vesta-gold);"></i>
                        Derecho de Rectificaci贸n
                    </h5>
                    <p class="text-muted small">Corrige datos incorrectos o desactualizados (Art. 16 RGPD)</p>
                    <button class="btn btn-action btn-sm" data-bs-toggle="modal" data-bs-target="#modalRectificacion">Solicitar Rectificaci贸n</button>
                </div>
            </div>

            <div class="col-md-6">
                <div class="action-card">
                    <h5 class="fw-bold mb-2">
                        <i class="bi bi-download" style="color: var(--vesta-gold);"></i>
                        Derecho de Portabilidad
                    </h5>
                    <p class="text-muted small">Descarga tus datos en formato JSON (Art. 20 RGPD)</p>
                    <button class="btn btn-action btn-sm" onclick="solicitarPortabilidad()">Descargar Datos</button>
                </div>
            </div>

            <div class="col-md-6">
                <div class="action-card">
                    <h5 class="fw-bold mb-2">
                        <i class="bi bi-x-circle text-danger"></i>
                        Derecho de Supresi贸n
                    </h5>
                    <p class="text-muted small">Elimina tu cuenta y datos (Derecho al olvido - Art. 17 RGPD)</p>
                    <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalSupresion">Eliminar Cuenta</button>
                </div>
            </div>
        </div>

        <h4 class="mt-5 mb-3"> Mis Solicitudes</h4>
        <div id="solicitudesList" class="action-card">
            <p class="text-muted text-center py-4">Cargando solicitudes...</p>
        </div>
        
        <div class="mt-4 text-center">
            <a href="/cliente/dashboard" class="btn btn-outline-secondary">Volver al Dashboard</a>
        </div>
    </div>

    <div class="modal fade" id="modalRectificacion" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Solicitar Rectificaci贸n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="descRectificacion" class="form-label">Describe qu茅 datos son incorrectos y cu谩les son los correctos:</label>
                        <textarea class="form-control" id="descRectificacion" rows="3" placeholder="Ej: He cambiado mi direcci贸n a Calle Nueva..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="procesarRectificacion()">Enviar Solicitud</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalSupresion" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">锔 Acci贸n Irreversible</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Vas a solicitar el borrado de tus datos (Derecho al olvido).</p>
                    <p class="small text-muted">Para confirmar, escribe <strong>ELIMINAR CUENTA</strong> en el campo de abajo:</p>
                    <input type="text" class="form-control mb-3" id="confirmacionBorrado" placeholder="ELIMINAR CUENTA">
                    
                    <label for="razonBorrado" class="form-label small">Motivo (Opcional):</label>
                    <input type="text" class="form-control" id="razonBorrado" placeholder="驴Por qu茅 nos dejas?">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="procesarSupresion()">Confirmar Eliminaci贸n</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="infoToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-primary text-white">
                <strong class="me-auto">Informaci贸n</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                Acci贸n realizada.
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const usuarioId = [[${userId}]]; 
        const apiBaseUrl = 'http://localhost:8080/api/derechos';
        /*]]>*/

        function mostrarToast(mensaje) {
            document.getElementById('toastMessage').textContent = mensaje;
            const toastEl = document.getElementById('infoToast');
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        async function solicitarAcceso() {
            // Acci贸n directa, solo informamos
            enviarSolicitud('solicitar-acceso', { usuarioId });
        }

        async function solicitarPortabilidad() {
            // Acci贸n directa
            enviarSolicitud('solicitar-portabilidad', { usuarioId });
        }

        async function procesarRectificacion() {
            const descripcion = document.getElementById('descRectificacion').value;
            if (!descripcion) {
                showInfoModal("Validaci贸n", "Por favor, describe la rectificaci贸n.");
                return;
            }
            
            // Cerrar modal
            const modalEl = document.getElementById('modalRectificacion');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            enviarSolicitud('solicitar-rectificacion', { usuarioId, descripcion });
        }

        async function procesarSupresion() {
            const confirmacion = document.getElementById('confirmacionBorrado').value;
            const razon = document.getElementById('razonBorrado').value;

            if (confirmacion !== 'ELIMINAR CUENTA') {
                showErrorModal("Error de Confirmaci贸n", "El texto de confirmaci贸n no coincide. Debes escribir exactamente: ELIMINAR CUENTA");
                return;
            }

            try {
                // Enviar solicitud
                await fetch(`${apiBaseUrl}/solicitar-supresion`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ usuarioId, descripcion: razon })
                });
                
                // Redirigir al logout
                window.location.href = '/logout';
            } catch (error) {
                console.error(error);
                mostrarToast('Error al procesar la solicitud.');
            }
        }

        async function enviarSolicitud(endpoint, data) {
            try {
                const response = await fetch(`${apiBaseUrl}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    mostrarToast(result.message);
                    cargarSolicitudes();
                } else {
                    mostrarToast('Error: ' + (result.message || 'No se pudo procesar'));
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarToast('Error de conexi贸n con el servidor.');
            }
        }

        async function cargarSolicitudes() {
            if (!usuarioId) return;
            
            try {
                const response = await fetch(`${apiBaseUrl}/mis-solicitudes/${usuarioId}`);
                const solicitudes = await response.json();
                
                const listContainer = document.getElementById('solicitudesList');
                
                if (solicitudes.length === 0) {
                    listContainer.innerHTML = '<p class="text-muted text-center py-4">No has realizado ninguna solicitud de derechos a煤n.</p>';
                    return;
                }
                
                const html = solicitudes.map(s => {
                    let badgeClass = 'bg-secondary';
                    if (s.estado === 'COMPLETADA') badgeClass = 'bg-success';
                    if (s.estado === 'PENDIENTE') badgeClass = 'bg-warning text-dark';
                    
                    return `
                    <div class="border-bottom pb-3 mb-3 last:border-0 last:pb-0 last:mb-0">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <strong class="text-primary">${s.tipoSolicitud}</strong>
                            <span class="badge ${badgeClass}">${s.estado}</span>
                        </div>
                        <p class="small text-muted mb-1">${s.descripcion || 'Sin descripci贸n'}</p>
                        <small class="text-muted" style="font-size: 0.75rem">
                            <i class="bi bi-calendar"></i> ${new Date(s.fechaSolicitud).toLocaleDateString('es-ES')}
                        </small>
                    </div>
                `}).join('');
                
                listContainer.innerHTML = html;
            } catch (error) {
                console.error('Error cargando solicitudes:', error);
            }
        }

        // Cargar solicitudes al inicio
        cargarSolicitudes();
        
        // Inicializar Bootstrap JS (necesario para modales y toasts)
        document.addEventListener('DOMContentLoaded', function() {
            // Limpiar inputs de modales al cerrar
            const modales = document.querySelectorAll('.modal');
            modales.forEach(modal => {
                modal.addEventListener('hidden.bs.modal', function () {
                    const inputs = this.querySelectorAll('input, textarea');
                    inputs.forEach(input => input.value = '');
                });
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/modal-utils.js}"></script>
</body>
</html>