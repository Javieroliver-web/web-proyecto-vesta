<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Mis Datos - Vesta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <style>
        :root { --vesta-gold: #f1a61c; --vesta-navy: #282c3f; }
        body { background: #f8f9fa; }
        .navbar-vesta { background: linear-gradient(135deg, var(--vesta-navy) 0%, #3c425e 100%); padding: 1rem 0; box-shadow: 0 2px 12px rgba(0,0,0,0.1); }
        .navbar-brand { color: var(--vesta-gold) !important; font-weight: 700; font-size: 1.5rem; }
        .action-card { background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.3s ease; }
        .action-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
        .btn-action { background: linear-gradient(135deg, var(--vesta-gold) 0%, #f4b94c 100%); border: none; color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 8px; }
    </style>
</head>
<body>
    <div th:replace="~{fragments/cookie-banner :: cookie-banner}"></div>

    <nav class="navbar navbar-expand-lg navbar-vesta">
        <div class="container">
            <a class="navbar-brand" href="/cliente/dashboard">
                <i class="bi bi-shield-check"></i> VESTA
            </a>
            <span class="text-white">Hola, <strong th:text="${nombreUsuario}">Usuario</strong></span>
        </div>
    </nav>

    <div class="container py-5">
        <h2 class="fw-bold mb-4">
            <i class="bi bi-person-lock" style="color: var(--vesta-gold);"></i>
            Gesti√≥n de Datos Personales
        </h2>

        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>Tus derechos bajo el RGPD:</strong> Aqu√≠ puedes ejercer tus derechos de acceso, rectificaci√≥n, supresi√≥n, portabilidad y oposici√≥n seg√∫n los art√≠culos 15-22 del RGPD.
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="action-card">
                    <h5 class="fw-bold mb-2">
                        <i class="bi bi-eye" style="color: var(--vesta-gold);"></i>
                        Derecho de Acceso
                    </h5>
                    <p class="text-muted small">Consulta qu√© datos personales tuyos almacenamos (Art. 15 RGPD)</p>
                    <button class="btn btn-action btn-sm" onclick="solicitarAcceso()">Solicitar Acceso</button>
                </div>
            </div>

            <div class="col-md-6">
                <div class="action-card">
                    <h5 class="fw-bold mb-2">
                        <i class="bi bi-pencil" style="color: var(--vesta-gold);"></i>
                        Derecho de Rectificaci√≥n
                    </h5>
                    <p class="text-muted small">Corrige datos incorrectos o desactualizados (Art. 16 RGPD)</p>
                    <button class="btn btn-action btn-sm" onclick="solicitarRectificacion()">Solicitar Rectificaci√≥n</button>
                </div>
            </div>

            <div class="col-md-6">
                <div class="action-card">
                    <h5 class="fw-bold mb-2">
                        <i class="bi bi-download" style="color: var(--vesta-gold);"></i>
                        Derecho de Portabilidad
                    </h5>
                    <p class="text-muted small">Descarga tus datos en formato JSON (Art. 20 RGPD)</p>
                    <button class="btn btn-action btn-sm" onclick="solicitarPortabilidad()">Descargar Datos</button>
                </div>
            </div>

            <div class="col-md-6">
                <div class="action-card">
                    <h5 class="fw-bold mb-2">
                        <i class="bi bi-x-circle text-danger"></i>
                        Derecho de Supresi√≥n
                    </h5>
                    <p class="text-muted small">Elimina tu cuenta y datos (Derecho al olvido - Art. 17 RGPD)</p>
                    <button class="btn btn-danger btn-sm" onclick="confirmarSupresion()">Eliminar Cuenta</button>
                </div>
            </div>
        </div>

        <h4 class="mt-5 mb-3">üìã Mis Solicitudes</h4>
        <div id="solicitudesList" class="action-card">
            <p class="text-muted text-center py-4">Cargando solicitudes...</p>
        </div>
        
        <div class="mt-4 text-center">
            <a href="/cliente/dashboard" class="btn btn-outline-secondary">Volver al Dashboard</a>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // INYECCI√ìN DE THYMELEAF: Aqu√≠ obtenemos el ID real del backend
        const usuarioId = [[${userId}]]; 
        const apiBaseUrl = 'http://localhost:8080/api/derechos';
        /*]]>*/

        console.log("Gesti√≥n RGPD inicializada para usuario ID:", usuarioId);

        async function solicitarAcceso() {
            if (!confirm('¬øSolicitar acceso a tus datos? Recibir√°s un informe en 30 d√≠as.')) return;
            enviarSolicitud('solicitar-acceso', { usuarioId });
        }

        async function solicitarRectificacion() {
            const descripcion = prompt('Describe qu√© datos necesitas rectificar (ej: cambio de direcci√≥n, nuevo email):');
            if (!descripcion) return;
            enviarSolicitud('solicitar-rectificacion', { usuarioId, descripcion });
        }

        async function solicitarPortabilidad() {
            if (!confirm('Recibir√°s tus datos en formato JSON en un plazo de 30 d√≠as. ¬øContinuar?')) return;
            enviarSolicitud('solicitar-portabilidad', { usuarioId });
        }

        async function confirmarSupresion() {
            const confirmacion = prompt('‚ö†Ô∏è ACCI√ìN IRREVERSIBLE\n\nEsta acci√≥n marcar√° tus datos para eliminaci√≥n seg√∫n el Art. 17 RGPD. Escribe "ELIMINAR CUENTA" para confirmar:');
            if (confirmacion !== 'ELIMINAR CUENTA') {
                alert('Cancelado');
                return;
            }
            
            const razon = prompt('(Opcional) ¬øPor qu√© nos dejas? Nos ayuda a mejorar.');
            
            try {
                await enviarSolicitud('solicitar-supresion', { usuarioId, descripcion: razon });
                // En caso de supresi√≥n, cerramos sesi√≥n tras el aviso
                setTimeout(() => window.location.href = '/logout', 2000);
            } catch (error) {
                // El error ya se maneja en enviarSolicitud
            }
        }

        async function enviarSolicitud(endpoint, data) {
            try {
                const response = await fetch(`${apiBaseUrl}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ ' + result.message);
                    cargarSolicitudes(); // Recargar la lista
                } else {
                    alert('‚ùå Error: ' + (result.message || 'No se pudo procesar la solicitud'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n con el servidor de derechos.');
            }
        }

        async function cargarSolicitudes() {
            if (!usuarioId) return;
            
            try {
                const response = await fetch(`${apiBaseUrl}/mis-solicitudes/${usuarioId}`);
                const solicitudes = await response.json();
                
                const listContainer = document.getElementById('solicitudesList');
                
                if (solicitudes.length === 0) {
                    listContainer.innerHTML = '<p class="text-muted text-center py-4">No has realizado ninguna solicitud de derechos a√∫n.</p>';
                    return;
                }
                
                const html = solicitudes.map(s => {
                    let badgeClass = 'bg-secondary';
                    if (s.estado === 'COMPLETADA') badgeClass = 'bg-success';
                    if (s.estado === 'PENDIENTE') badgeClass = 'bg-warning text-dark';
                    if (s.estado === 'EN_PROCESO') badgeClass = 'bg-info text-dark';
                    
                    return `
                    <div class="border-bottom pb-3 mb-3 last:border-0 last:pb-0 last:mb-0">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <strong class="text-primary">${s.tipoSolicitud}</strong>
                            <span class="badge ${badgeClass}">${s.estado}</span>
                        </div>
                        <p class="small text-muted mb-1">${s.descripcion || 'Sin descripci√≥n'}</p>
                        <small class="text-muted" style="font-size: 0.75rem">
                            <i class="bi bi-calendar"></i> ${new Date(s.fechaSolicitud).toLocaleDateString('es-ES')} 
                            at ${new Date(s.fechaSolicitud).toLocaleTimeString('es-ES')}
                        </small>
                    </div>
                `}).join('');
                
                listContainer.innerHTML = html;
            } catch (error) {
                console.error('Error cargando solicitudes:', error);
                document.getElementById('solicitudesList').innerHTML = '<p class="text-danger text-center">Error al cargar el historial.</p>';
            }
        }

        // Cargar solicitudes al inicio
        cargarSolicitudes();
    </script>
</body>
</html>