<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Admin Dashboard - Vesta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .sidebar { min-height: 100vh; background: #282c3f; color: white; }
        .nav-link { color: rgba(255,255,255,0.7); cursor: pointer; }
        .nav-link:hover, .nav-link.active { color: #f1a61c; background: rgba(255,255,255,0.05); }
        .stat-card { border-left: 4px solid #f1a61c; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
        
        /* Estilos para el Modal de Siniestro */
        #imageContainer {
            min-height: 200px;
            background-color: #e9ecef;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            border: 2px dashed #adb5bd;
            padding: 1rem;
        }
    </style>
</head>
<body>
    <div class="d-flex">
        <div class="sidebar p-3 d-flex flex-column" style="width: 250px;">
            <h4 class="mb-4 text-center fw-bold text-white">
                <i class="bi bi-shield-check" style="color: #f1a61c;"></i> ADMIN
            </h4>
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showTab('ordenes', event)">
                        <i class="bi bi-cart me-2"></i> Ventas
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('siniestros', event)">
                        <i class="bi bi-exclamation-triangle me-2"></i> Siniestros
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('rgpd', event)">
                        <i class="bi bi-file-earmark-lock me-2"></i> RGPD
                    </a>
                </li>
            </ul>
            <div class="mt-auto pt-3 border-top border-secondary">
                <div class="d-flex align-items-center mb-2 px-2 text-white small">
                    <i class="bi bi-person-circle me-2"></i>
                    <span th:text="${nombreUsuario}">Admin</span>
                </div>
                <a href="/logout" class="btn btn-outline-danger btn-sm w-100">Cerrar Sesión</a>
            </div>
        </div>

        <div class="flex-grow-1 p-4" style="height: 100vh; overflow-y: auto;">
            
            <div id="tab-ordenes">
                <h3 class="fw-bold mb-4">Gestión de Ventas</h3>
                
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card stat-card shadow-sm border-0">
                            <div class="card-body">
                                <h6 class="text-muted text-uppercase small">Total Órdenes</h6>
                                <h2 class="fw-bold mb-0" th:text="${#lists.size(ordenes)}">0</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-0 fw-bold py-3">
                        <i class="bi bi-receipt me-2 text-warning"></i> Últimas Transacciones
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Referencia</th>
                                    <th>Fecha</th>
                                    <th>Cliente ID</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="ord : ${ordenes}">
                                    <td class="fw-bold font-monospace" th:text="${ord.referencia}">REF-001</td>
                                    <td th:text="${#strings.substring(ord.fecha, 0, 10)}">2024-01-01</td>
                                    <td><span class="badge bg-light text-dark border" th:text="'User #' + ${ord.usuarioId}">#1</span></td>
                                    <td class="text-success fw-bold" th:text="${ord.total} + '€'">0.00€</td>
                                    <td><span class="badge bg-success" th:text="${ord.estado}">COMPLETADA</span></td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(ordenes)}">
                                    <td colspan="5" class="text-center py-5 text-muted">
                                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                        No hay ventas registradas.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-siniestros" style="display: none;">
                <h3 class="fw-bold mb-4">Gestión de Siniestros (IA)</h3>
                
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-0 fw-bold py-3">
                        <i class="bi bi-robot me-2 text-warning"></i> Reportes Recibidos
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Fecha</th>
                                    <th>Cliente</th>
                                    <th>Póliza</th>
                                    <th>IA / Fraude</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="sin : ${siniestros}">
                                    <td class="text-muted fw-bold">#<span th:text="${sin.id}">1</span></td>
                                    <td th:text="${sin.fecha}">2025-01-01</td>
                                    
                                    <!-- NUEVA COLUMNA: Cliente -->
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-person-circle text-primary me-2"></i>
                                            <div>
                                                <div class="fw-bold small" th:text="${sin.poliza.usuario.nombreCompleto}">Usuario</div>
                                                <div class="text-muted" style="font-size: 0.7rem;" th:text="${sin.poliza.usuario.email}">email@example.com</div>
                                            </div>
                                        </div>
                                    </td>
                                    
                                    <td><span class="badge bg-light text-dark border">POL-<span th:text="${sin.poliza.id}">1</span></span></td>
                                    
                                    <td>
                                        <div class="d-flex flex-column gap-1">
                                            <small class="d-flex align-items-center">
                                                <i th:if="${#strings.contains(sin.analisisIA, 'APROBADO')}" class="bi bi-check-circle-fill text-success me-1"></i>
                                                <i th:unless="${#strings.contains(sin.analisisIA, 'APROBADO')}" class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
                                                <span class="text-truncate" style="max-width: 150px;" th:text="${sin.analisisIA}" th:title="${sin.analisisIA}">IA...</span>
                                            </small>
                                            <div class="progress" style="height: 6px; width: 100px;">
                                                <div th:class="${'progress-bar ' + (sin.fraudeScore > 50 ? 'bg-danger' : 'bg-success')}" 
                                                     role="progressbar" 
                                                     th:style="'width: ' + ${sin.fraudeScore} + '%'"></div>
                                            </div>
                                            <span style="font-size: 0.7rem;" class="text-muted">Riesgo Fraude: <span th:text="${sin.fraudeScore}">0</span>%</span>
                                        </div>
                                    </td>

                                    <td>
                                        <span th:if="${sin.estado == 'PENDIENTE_REVISION'}" class="badge bg-warning text-dark">PENDIENTE</span>
                                        <span th:if="${sin.estado == 'APROBADO'}" class="badge bg-success">APROBADO</span>
                                        <span th:if="${sin.estado == 'RECHAZADO'}" class="badge bg-danger">RECHAZADO</span>
                                    </td>

                                    <td>
                                        <button class="btn btn-sm btn-primary" 
                                                th:onclick="abrirModalSiniestro([[${sin.id}]], [[${sin.descripcion}]], [[${sin.imagenUrl}]], [[${sin.analisisIA}]], [[${sin.fraudeScore}]], [[${sin.poliza.usuario.nombreCompleto}]], [[${sin.poliza.usuario.email}]], [[${sin.poliza.id}]])">
                                            <i class="bi bi-eye"></i> Revisar
                                        </button>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(siniestros)}">
                                    <td colspan="7" class="text-center py-5 text-muted">
                                        <i class="bi bi-shield-check fs-1 d-block mb-2"></i>
                                        No hay siniestros reportados.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-rgpd" style="display: none;">
                <h3 class="fw-bold mb-4">Cumplimiento RGPD</h3>
                
                <div class="alert alert-warning border-0 shadow-sm d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                    <div>
                        <strong>Atención Requerida:</strong> Las solicitudes de Derecho de Supresión (Olvido) deben procesarse en un plazo máximo de 30 días.
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-0 fw-bold py-3">
                        <i class="bi bi-list-check me-2 text-warning"></i> Solicitudes Recibidas (ARCO)
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Tipo Derecho</th>
                                    <th>Usuario ID</th>
                                    <th>Detalle / Motivo</th>
                                    <th>Fecha Solicitud</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="sol : ${solicitudes}">
                                    <td class="text-muted" th:text="${sol.id}">1</td>
                                    <td><strong class="text-primary" th:text="${sol.tipoSolicitud}">ACCESO</strong></td>
                                    <td th:text="${sol.usuarioId}">1</td>
                                    <td class="small text-muted" style="max-width: 300px;" th:text="${sol.descripcion}">-</td>
                                    <td th:text="${#strings.substring(sol.fechaSolicitud, 0, 10)}">2024-01-01</td>
                                    <td>
                                        <span th:class="${'badge ' + (sol.estado == 'PENDIENTE' ? 'bg-warning text-dark' : 'bg-success')}" 
                                              th:text="${sol.estado}">PENDIENTE</span>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(solicitudes)}">
                                    <td colspan="6" class="text-center py-5 text-muted">
                                        <i class="bi bi-check-circle fs-1 d-block mb-2 text-success"></i>
                                        Todo al día. No hay solicitudes pendientes.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="modalDetalleSiniestro" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Revisión de Siniestro #<span id="modalId"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 text-center bg-light d-flex align-items-center justify-content-center p-3 rounded">
                            <div id="imageContainer">
                                <i class="bi bi-image display-1 text-muted"></i>
                                <p class="text-muted mb-1">Cargando evidencia...</p>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <!-- Información del Cliente -->
                            <div class="mb-3 p-3 bg-light rounded border">
                                <h6 class="fw-bold mb-2"><i class="bi bi-person-badge text-primary"></i> Cliente</h6>
                                <div class="d-flex align-items-center mb-1">
                                    <i class="bi bi-person-circle text-muted me-2"></i>
                                    <span class="fw-bold" id="modalClienteNombre">...</span>
                                </div>
                                <div class="d-flex align-items-center mb-1">
                                    <i class="bi bi-envelope text-muted me-2"></i>
                                    <small class="text-muted" id="modalClienteEmail">...</small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-shield-check text-muted me-2"></i>
                                    <small class="text-muted">Póliza #<span id="modalPolizaId">...</span></small>
                                </div>
                            </div>
                            
                            <h6 class="fw-bold">Declaración del Cliente:</h6>
                            <p class="p-3 bg-light rounded fst-italic" id="modalDesc">...</p>
                            
                            <hr>
                            
                            <h6 class="fw-bold text-primary"><i class="bi bi-robot"></i> Análisis IA Vesta</h6>
                            <div class="alert alert-info py-2 small" id="modalIA">...</div>
                            
                            <h6 class="fw-bold text-danger"><i class="bi bi-shield-exclamation"></i> Score de Fraude</h6>
                            <div class="d-flex align-items-center mb-3">
                                <h2 class="mb-0 me-3" id="modalScore">0%</h2>
                                <span class="badge bg-secondary" id="modalRiskLabel">Bajo Riesgo</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <div>
                        <button type="button" class="btn btn-danger me-2" onclick="actualizarSiniestro('RECHAZADO')">
                            <i class="bi bi-x-circle"></i> Rechazar
                        </button>
                        <button type="button" class="btn btn-success" onclick="actualizarSiniestro('APROBADO')">
                            <i class="bi bi-check-circle"></i> Aprobar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/modal-utils.js}"></script>
    <script th:inline="javascript">
        // Variables globales
        let currentSiniestroId = null;
        /*<![CDATA[*/
        const token = [[${session.token}]];
        /*]]>*/
        const apiBaseUrl = 'http://localhost:8080/api'; 

        function showTab(tabId, event) {
            // Ocultar todos
            document.getElementById('tab-ordenes').style.display = 'none';
            document.getElementById('tab-rgpd').style.display = 'none';
            document.getElementById('tab-siniestros').style.display = 'none';
            
            // Gestionar clases activas
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            
            // Mostrar seleccionado
            document.getElementById('tab-' + tabId).style.display = 'block';
            if(event) event.currentTarget.classList.add('active');
        }

        // Abrir Modal con datos cargados
        function abrirModalSiniestro(id, desc, imgUrl, ia, score, clienteNombre, clienteEmail, polizaId) {
            currentSiniestroId = id;
            document.getElementById('modalId').innerText = id;
            document.getElementById('modalDesc').innerText = desc;
            
            // Información del cliente
            document.getElementById('modalClienteNombre').innerText = clienteNombre;
            document.getElementById('modalClienteEmail').innerText = clienteEmail;
            document.getElementById('modalPolizaId').innerText = polizaId;
            
            // === LÓGICA DE IMAGEN AÑADIDA ===
            // Construir la URL completa apuntando al servidor API (backend)
            // Se asume que imgUrl es algo como "uploads/foto.jpg"
            const fullImageUrl = 'http://localhost:8080/' + imgUrl;
            
            const imgContainer = document.getElementById('imageContainer');
            // Insertar etiqueta IMG real
            imgContainer.innerHTML = `
                <img src="${fullImageUrl}" class="img-fluid rounded shadow-sm" 
                     style="max-height: 300px; object-fit: contain;" 
                     alt="Evidencia" 
                     onerror="this.src=''; this.parentElement.innerHTML='<div class=\'text-danger\'><i class=\'bi bi-exclamation-triangle\'></i> No se pudo cargar la imagen</div>'">
            `;
            
            document.getElementById('modalIA').innerText = ia;
            document.getElementById('modalScore').innerText = score + '%';
            
            // Configurar etiqueta de riesgo según el score
            const label = document.getElementById('modalRiskLabel');
            if(score > 70) { 
                label.className = 'badge bg-danger'; 
                label.innerText = 'Riesgo Crítico'; 
            } else if(score > 40) { 
                label.className = 'badge bg-warning text-dark'; 
                label.innerText = 'Riesgo Medio'; 
            } else { 
                label.className = 'badge bg-success'; 
                label.innerText = 'Riesgo Bajo'; 
            }

            new bootstrap.Modal(document.getElementById('modalDetalleSiniestro')).show();
        }

        // Llamada a la API para aprobar/rechazar
        async function actualizarSiniestro(nuevoEstado) {
            // Usar modal de confirmación en lugar de confirm()
            showConfirmModal(
                "Confirmar Acción",
                `¿Estás seguro de marcar este siniestro como ${nuevoEstado}?`,
                async () => {
                    // Callback al confirmar
                    try {
                        const res = await fetch(`${apiBaseUrl}/siniestros/${currentSiniestroId}/estado`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + token
                            },
                            body: JSON.stringify({ estado: nuevoEstado })
                        });

                        if(res.ok) {
                            showSuccessModal('Éxito', 'Estado actualizado correctamente.');
                            setTimeout(() => window.location.reload(), 1500);
                        } else {
                            const data = await res.json();
                            showErrorModal('Error', data.message || 'No se pudo actualizar el estado.');
                        }
                    } catch(e) {
                        console.error(e);
                        showErrorModal('Error de Conexión', 'No se pudo conectar con el servidor.');
                    }
                }
            );
        }
    </script>
    <script src="/static/js/voice-assistant.js"></script>
</body>
</html>