<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Configuración - Vesta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>

    <div th:replace="~{fragments/header :: header-nav}"></div>

    <div class="container py-5">
        <h2 class="fw-bold mb-4">⚙️ Configuración</h2>

        <div class="row">
            <div class="col-md-3 mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="list-group list-group-flush rounded-3">
                        <a href="#general" class="list-group-item list-group-item-action active" data-bs-toggle="list">
                            <i class="bi bi-sliders me-2"></i> General
                        </a>
                        <a href="#cuenta" class="list-group-item list-group-item-action" data-bs-toggle="list">
                            <i class="bi bi-shield-lock me-2"></i> Cuenta y Seguridad
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div class="tab-content">
                    
                    <div class="tab-pane fade show active" id="general">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-transparent border-0 pt-4 px-4">
                                <h5 class="fw-bold mb-0">Apariencia</h5>
                            </div>
                            <div class="card-body px-4 pb-4">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="fw-bold mb-1">Modo Oscuro</h6>
                                        <p class="text-muted small mb-0">Cambia la apariencia de la aplicación para reducir la fatiga visual.</p>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="themeToggle" style="width: 3em; height: 1.5em; cursor: pointer;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SECCIÓN UBICACIÓN (NUEVO) -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-transparent border-0 pt-4 px-4">
                                <h5 class="fw-bold mb-0">Ubicación y Clima</h5>
                            </div>
                            <div class="card-body px-4 pb-4">
                                <form id="locationForm">
                                    <div class="mb-3">
                                        <label class="form-label">Ciudad Predeterminada</label>
                                        <div class="input-group position-relative">
                                            <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                                            <input type="text" class="form-control" id="ciudadInput" placeholder="Ej: Sevilla, ES" autocomplete="off">
                                            <button class="btn btn-primary" type="submit">Guardar</button>
                                            <!-- Lista de Autocompletado -->
                                            <div id="cityList" class="list-group position-absolute w-100 shadow" style="top: 100%; left: 0; z-index: 1050; display: none; max-height: 200px; overflow-y: auto;"></div>
                                        </div>
                                        <div class="form-text">Usado para la previsión meteorológica del Dashboard.</div>
                                    </div>
                                </form>
                                <div id="locMsgBox" class="mt-2" style="display:none"></div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="cuenta">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-transparent border-0 pt-4 px-4">
                                <h5 class="fw-bold mb-0">Cambiar Contraseña</h5>
                            </div>
                            <div class="card-body px-4 pb-4">
                                <form id="passwordForm">
                                    <div class="mb-3">
                                        <label class="form-label">Contraseña Actual <span class="text-danger">*</span></label>
                                        <input type="password" class="form-control" id="currentPassword" required placeholder="Escribe tu contraseña actual">
                                    </div>
                                    
                                    <hr class="my-4">
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Nueva Contraseña</label>
                                        <input type="password" class="form-control" id="newPassword" required minlength="6">
                                    </div>
                                    <div class="mb-4">
                                        <label class="form-label">Confirmar Nueva Contraseña</label>
                                        <input type="password" class="form-control" id="confirmPassword" required minlength="6">
                                    </div>
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                        <button type="submit" class="btn btn-primary">Actualizar Contraseña</button>
                                    </div>
                                </form>
                                
                                <div id="msgBox" class="mt-3" style="display:none"></div>
                            </div>
                        </div>

                        <!-- ZONA DE PELIGRO -->
                        <div class="card border-danger shadow-sm mt-4">
                            <div class="card-header bg-danger-subtle text-danger border-0 pt-4 px-4">
                                <h5 class="fw-bold mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>Zona de Peligro</h5>
                            </div>
                            <div class="card-body px-4 pb-4">
                                <p class="text-muted">Una vez que elimines tu cuenta, no hay vuelta atrás. Por favor, asegúrate.</p>
                                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                    Eliminar Cuenta
                                </button>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Eliminar -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">¿Estás absolutamente seguro?</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Esta acción <strong>no se puede deshacer</strong>. Esto eliminará permanentemente tu cuenta, tus pólizas contratadas y tus siniestros registrados.</p>
                    <div class="mb-3">
                        <label class="form-label">Escribe <strong>BORRAR</strong> para confirmar:</label>
                        <input type="text" class="form-control" id="deleteConfirmInput" onkeyup="verificarBorrado()" placeholder="Escribe BORRAR aquí">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btnDeleteFinal" disabled onclick="eliminarCuenta()">Eliminar esta cuenta</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script th:inline="javascript">
        // === LÓGICA TEMA OSCURO ===
        const toggle = document.getElementById('themeToggle');
        const root = document.documentElement;
        
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme === 'dark') {
            root.setAttribute('data-theme', 'dark');
            toggle.checked = true;
        }

        toggle.addEventListener('change', async function() {
            const newTheme = this.checked ? 'dark' : 'light';
            
            // 1. Aplicar localmente
            if (this.checked) {
                root.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            } else {
                root.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            }

            // 2. Guardar en Base de Datos
            try {
                await fetch(`${apiBaseUrl}/${userId}`, {
                    method: 'PUT',
                     headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token 
                    },
                    body: JSON.stringify({ tema: newTheme })
                });
            } catch (e) {
                console.error("Error saving theme preference", e);
            }
        });

        // === LÓGICA CAMBIO CONTRASEÑA ===
        const userId = [[${usuarioId}]];
        const token = [[${session.token}]];
        const apiBaseUrl = window.location.protocol + '//' + window.location.hostname + ':8080/api/usuarios';

        // 1. CARGAR DATOS USUARIO
        async function loadUserData() {
            try {
                const res = await fetch(`${apiBaseUrl}/${userId}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (res.ok) {
                    const user = await res.json();
                    
                    // Cargar Ciudad
                    if (user.ciudad) {
                        document.getElementById('ciudadInput').value = user.ciudad;
                    }

                    // Sincronizar Tema desde BD
                    if (user.tema) {
                        const localTheme = localStorage.getItem('theme');
                        // Priorizar la configuración guardada en BD si es diferente
                        if (user.tema !== localTheme) {
                            localStorage.setItem('theme', user.tema);
                            root.setAttribute('data-theme', user.tema);
                            toggle.checked = (user.tema === 'dark');
                        } else {
                            // Asegurar que el toggle esté correcto
                            toggle.checked = (user.tema === 'dark');
                        }
                    }
                }
            } catch (e) { console.error("Error loading user data", e); }
        }
        loadUserData();

        // 2. GUARDAR UBICACIÓN
        document.getElementById('locationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const ciudad = document.getElementById('ciudadInput').value;
            const msgBox = document.getElementById('locMsgBox');
            
            try {
                const res = await fetch(`${apiBaseUrl}/${userId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token 
                    },
                    body: JSON.stringify({ ciudad: ciudad })
                });

                if (res.ok) {
                    msgBox.style.display = 'block';
                    msgBox.className = 'alert alert-success mt-2';
                    msgBox.innerText = 'Ubicación verificada y guardada correctamente.';
                    setTimeout(() => msgBox.style.display = 'none', 3000);
                    // Actualizar localStorage para el dashboard
                    loadUserData(); 
                } else {
                    const err = await res.json();
                    msgBox.style.display = 'block';
                    msgBox.className = 'alert alert-danger mt-2';
                    msgBox.innerText = err.message || 'Error al validar la ubicación.';
                    setTimeout(() => msgBox.style.display = 'none', 3000);
                }
            } catch (e) {
                console.error(e);
                msgBox.style.display = 'block';
                msgBox.className = 'alert alert-danger mt-2';
                msgBox.innerText = 'Error de conexión con el servidor.';
                setTimeout(() => msgBox.style.display = 'none', 3000);
            }
        });

        // === AUTOCOMPLETADO DE CIUDADES ===
        const ciudadInput = document.getElementById('ciudadInput');
        const cityList = document.getElementById('cityList');
        let debounceTimer;

        // Base URL para Clima
        const weatherApiUrl = apiBaseUrl.replace('/usuarios', '/clima');

        ciudadInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            const query = this.value;
            if (query.length < 3) {
                cityList.style.display = 'none';
                return;
            }

            debounceTimer = setTimeout(async () => {
                try {
                    // Usar token si fuera necesario, pero el endpoint es público/autenticado segun config
                    // Asumimos que requiere token si está segura
                    const res = await fetch(`${weatherApiUrl}/buscar?q=${query}`, {
                         headers: { 'Authorization': 'Bearer ' + token }
                    });
                    
                    if (res.ok) {
                        const cities = await res.json();
                        renderCities(cities);
                    }
                } catch(e) { console.error("Error fetching cities", e); }
            }, 400);
        });

        function renderCities(cities) {
            cityList.innerHTML = '';
            if (!cities || cities.length === 0) {
                cityList.style.display = 'none';
                return;
            }

            cities.forEach(city => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'list-group-item list-group-item-action text-start';
                const country = city.country ? `, ${city.country}` : '';
                const state = city.state ? ` (${city.state})` : '';
                const fullName = `${city.name}${state}${country}`;
                
                item.innerHTML = `<i class="bi bi-geo-alt me-2 text-primary"></i>${fullName}`;
                item.onclick = () => {
                    ciudadInput.value = `${city.name}${country}`; // Guardamos "Nombre, Pais"
                    cityList.style.display = 'none';
                };
                cityList.appendChild(item);
            });
            cityList.style.display = 'block';
        }

        // Ocultar lista al hacer click fuera
        document.addEventListener('click', function(e) {
            if (e.target !== ciudadInput && e.target !== cityList) {
                cityList.style.display = 'none';
            }
        });

        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const currentPass = document.getElementById('currentPassword').value; // Recuperar valor
            const p1 = document.getElementById('newPassword').value;
            const p2 = document.getElementById('confirmPassword').value;
            const msgBox = document.getElementById('msgBox');

            if (p1 !== p2) {
                showMsg('Las nuevas contraseñas no coinciden', 'danger');
                return;
            }

            // Crear el objeto JSON con la estructura que espera el nuevo controlador
            const payload = {
                currentPassword: currentPass,
                newPassword: p1
            };

            try {
                const response = await fetch(`${apiBaseUrl}/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(payload)
                });
                
                // Parsear respuesta, tanto si es OK como si es ERROR
                const data = await response.json().catch(() => ({})); 

                if (response.ok) {
                    showMsg('Contraseña actualizada correctamente', 'success');
                    document.getElementById('passwordForm').reset();
                } else {
                    // Mostrar mensaje específico del servidor ("Contraseña actual incorrecta")
                    showMsg(data.message || 'Error al actualizar. Verifica tus datos.', 'danger');
                }
            } catch (error) {
                console.error(error);
                showMsg('Error de conexión con el servidor', 'danger');
            }

            function showMsg(text, type) {
                msgBox.style.display = 'block';
                msgBox.className = `alert alert-${type} mt-3`;
                msgBox.textContent = text;
            }
        });

        // === BORRADO DE CUENTA ===
        function verificarBorrado() {
            const input = document.getElementById('deleteConfirmInput');
            const btn = document.getElementById('btnDeleteFinal');
            // Validar que sea exactamente "BORRAR" (Match Case)
            if (input.value === 'BORRAR') {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }

        async function eliminarCuenta() {
            const btn = document.getElementById('btnDeleteFinal');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Eliminando...';
            btn.disabled = true;

            try {
                const res = await fetch(`${apiBaseUrl}/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (res.ok) {
                    alert('Tu cuenta ha sido eliminada correctamente. Lamentamos verte partir.');
                    window.location.href = '/logout'; 
                } else {
                    alert('Error al eliminar la cuenta. Inténtalo de nuevo.');
                    btn.innerText = 'Eliminar esta cuenta';
                    btn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                alert('Error de conexión.');
                btn.innerText = 'Eliminar esta cuenta';
                btn.disabled = false;
            }
        }
    </script>
    <script src="/static/js/voice-assistant.js"></script>
</body>
</html>