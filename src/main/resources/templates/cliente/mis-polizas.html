<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Mis Pólizas - Vesta Seguros</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <style>
        /* Eliminado :root y body para usar variables globales de styles.css */

        .page-header {
            background: var(--theme-card-bg, white);
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: var(--shadow-sm);
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--theme-text-main, #282c3f);
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: var(--theme-text-muted, #6c757d);
            font-size: 1.1rem;
        }

        /* Stats Cards */
        .stats-card {
            background: var(--theme-card-bg, white);
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
            border: 1px solid var(--theme-border, transparent);
        }

        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stats-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        .stats-icon.blue {
            /* Palette: Dark Blue */
            background: linear-gradient(135deg, #3c425e 0%, #282c3f 100%);
            color: #f7cc7c; /* Gold Icon */
        }

        .stats-icon.green {
            /* Palette: Gold/Orange */
            background: linear-gradient(135deg, #f4b94c 0%, #f1a61c 100%);
            color: white;
        }

        .stats-icon.purple {
            /* Palette: Deep Dark */
            background: linear-gradient(135deg, #282c3f 0%, #141620 100%);
            color: #f7cc7c; /* Gold Icon */
        }

        .stats-label {
            font-size: 0.9rem;
            color: var(--theme-text-muted, #6c757d);
            margin-bottom: 5px;
        }

        .stats-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--theme-text-main, #282c3f);
        }

        /* Filters */
        .filters-section {
            background: var(--theme-card-bg, white);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--theme-border, transparent);
        }

        .filter-btn {
            border: 2px solid var(--theme-border, #e9ecef);
            background: var(--theme-bg-secondary, white);
            color: var(--theme-text-muted, #6c757d);
            padding: 10px 24px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            border-color: var(--vesta-gold);
            color: var(--vesta-gold);
            background: var(--theme-card-bg, white);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, var(--vesta-gold) 0%, #f4b94c 100%);
            color: white;
            border-color: var(--vesta-gold);
        }

        /* Poliza Cards */
        .poliza-card {
            background: var(--theme-card-bg, white);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
            border: 1px solid var(--theme-border, transparent);
        }

        .poliza-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .poliza-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .poliza-image {
            width: 100px;
            height: 100px;
            border-radius: 12px;
            object-fit: cover;
        }

        .poliza-info {
            flex-grow: 1;
        }

        .poliza-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--theme-text-main, #282c3f);
            margin-bottom: 8px;
        }

        .poliza-number {
            color: var(--theme-text-muted, #6c757d);
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        .poliza-dates {
            display: flex;
            gap: 30px;
            color: var(--theme-text-muted, #6c757d);
            font-size: 0.95rem;
        }

        .poliza-dates i {
            color: var(--vesta-gold);
            margin-right: 6px;
        }

        .poliza-price {
            text-align: right;
        }

        .poliza-price-amount {
            font-size: 2rem;
            font-weight: 700;
            color: var(--vesta-gold);
        }

        .poliza-actions {
            display: flex;
            gap: 10px;
            padding-top: 20px;
            border-top: 2px solid var(--theme-bg-secondary, #f8f9fa);
        }

        .btn-action {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-reportar {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
        }

        .btn-reportar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: var(--theme-card-bg, white);
            border-radius: 16px;
            border: 1px solid var(--theme-border, transparent);
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--theme-text-muted, #6c757d);
            margin-bottom: 20px;
        }

        .empty-state h5 {
            color: var(--theme-text-main, #282c3f);
            margin-bottom: 10px;
        }

        .empty-state p {
            color: var(--theme-text-muted, #6c757d);
            margin-bottom: 25px;
        }
    </style>
</head>

<body>
    <div th:replace="~{fragments/header :: header-nav}"></div>

    <div class="page-header">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <h2 class="page-title">Mis Pólizas</h2>
                <p class="page-subtitle">Gestiona tus seguros contratados</p>
            </div>
            <button class="btn btn-primary btn-lg" onclick="descargarPDF()">
                <i class="bi bi-file-earmark-pdf me-2"></i>Descargar Resumen
            </button>
        </div>
    </div>

    <div class="container mb-5">
        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-icon blue">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <div class="stats-label">Pólizas Activas</div>
                    <div class="stats-value" id="polizasActivas">0</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-icon green">
                        <i class="bi bi-currency-dollar"></i>
                    </div>
                    <div class="stats-label">Total Invertido</div>
                    <div class="stats-value" id="totalInvertido">$0.00</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-icon purple">
                        <i class="bi bi-file-text"></i>
                    </div>
                    <div class="stats-label">Total Pólizas</div>
                    <div class="stats-value" id="totalPolizas">0</div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <div class="d-flex gap-3">
                <button class="filter-btn active" onclick="filtrarPolizas('todas')">
                    Todas (<span id="countTodas">0</span>)
                </button>
                <button class="filter-btn" onclick="filtrarPolizas('activas')">
                    Activas (<span id="countActivas">0</span>)
                </button>
                <button class="filter-btn" onclick="filtrarPolizas('inactivas')">
                    Inactivas (<span id="countInactivas">0</span>)
                </button>
            </div>
        </div>

        <!-- Polizas List -->
        <div id="polizasContainer">
            <div class="text-center py-5">
                <div class="spinner-border" style="color: var(--vesta-gold);" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="text-muted mt-3">Cargando tus pólizas...</p>
            </div>
        </div>
    </div>

    <!-- Modal Reportar Siniestro -->
    <div class="modal fade" id="siniestroModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Reportar Siniestro</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formSiniestro">
                        <input type="hidden" id="polizaId" value="">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Describe qué pasó:</label>
                            <textarea class="form-control" id="descSiniestro" rows="3"
                                placeholder="Ej: Se me cayó el móvil y se rompió la pantalla..." required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Sube una foto del daño:</label>
                            <input type="file" class="form-control" id="fotoSiniestro" accept="image/*" required>
                            <small class="text-muted">La IA analizará esta imagen automáticamente.</small>
                        </div>
                    </form>
                    <div id="analisisResult" class="alert d-none mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="btnEnviarSiniestro" class="btn btn-danger" onclick="enviarSiniestro()">
                        Enviar Reporte
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/modal-utils.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        const authToken = /*[[${ session.token }]]*/ null;
        /*]]>*/

        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:8080/api'
            : 'http://vesta-api:8080/api';

        let todasLasPolizas = [];
        let filtroActual = 'todas';

        window.onload = function () {
            cargarPolizas();
        };

        // Función para obtener imagen por defecto según categoría
        function getDefaultImage(categoria) {
            const imageMap = {
                'Viaje': '/images/productos/viaje.png',
                'Tecnología': '/images/productos/tecnologia.png',
                'Entretenimiento': '/images/productos/Entretenimiento.jpg',
                'Movilidad': '/images/productos/movilidad.png',
                'Mascotas': '/images/productos/mascotas.png'
            };
            return imageMap[categoria] || '/images/productos/viaje.png';
        }

        async function cargarPolizas() {
            try {
                const res = await fetch(`${API_URL}/polizas/usuario`, {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });

                if (res.ok) {
                    todasLasPolizas = await res.json();
                    calcularEstadisticas();
                    renderizarPolizas(todasLasPolizas);
                } else {
                    mostrarError('Error al cargar pólizas');
                }
            } catch (e) {
                console.error('Error:', e);
                mostrarError('Error de conexión con el servidor');
            }
        }

        function calcularEstadisticas() {
            const activas = todasLasPolizas.filter(p => p.estado === 'ACTIVA').length;
            const total = todasLasPolizas.reduce((sum, p) => sum + parseFloat(p.precioFinal || 0), 0);

            document.getElementById('polizasActivas').textContent = activas;
            document.getElementById('totalInvertido').textContent = '$' + total.toFixed(2);
            document.getElementById('totalPolizas').textContent = todasLasPolizas.length;

            document.getElementById('countTodas').textContent = todasLasPolizas.length;
            document.getElementById('countActivas').textContent = activas;
            document.getElementById('countInactivas').textContent = todasLasPolizas.length - activas;
        }

        function renderizarPolizas(polizas) {
            const container = document.getElementById('polizasContainer');

            if (polizas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <h5>No tienes pólizas ${filtroActual === 'todas' ? '' : filtroActual}</h5>
                        <p>Explora nuestro marketplace y contrata tu primer seguro</p>
                        <a href="/cliente/marketplace" class="btn btn-primary">
                            <i class="bi bi-shop me-2"></i>Ir al Marketplace
                        </a>
                    </div>
                `;
                return;
            }

            container.innerHTML = polizas.map(poliza => `
                <div class="poliza-card">
                    <div class="poliza-header">
                        <img src="${poliza.producto.imagenUrl || 'https://via.placeholder.com/100'}" 
                             alt="${poliza.producto.nombre}" class="poliza-image"
                             onerror="this.onerror=null; this.src=getDefaultImage('${poliza.producto.categoria}');">
                        <div class="poliza-info">
                            <h5 class="poliza-title">
                                ${poliza.producto.nombre}
                                <span class="badge bg-success ms-2">${poliza.estado}</span>
                            </h5>
                            <div class="poliza-number">Póliza No. VES-${new Date().getFullYear()}-${String(poliza.id).padStart(6, '0')}</div>
                            <div class="poliza-dates">
                                <span><i class="bi bi-calendar-check"></i> Inicio: ${poliza.fechaInicio}</span>
                                <span><i class="bi bi-calendar-check"></i> Fin: ${poliza.fechaFin}</span>
                            </div>
                        </div>
                        <div class="poliza-price">
                            <div class="poliza-price-amount">$${parseFloat(poliza.precioFinal).toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="poliza-actions">
                        <button class="btn btn-action btn-reportar" onclick="abrirModalSiniestro(${poliza.id})">
                            <i class="bi bi-exclamation-triangle me-2"></i>Reportar Siniestro
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function filtrarPolizas(filtro) {
            filtroActual = filtro;

            // Actualizar botones activos
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            let polizasFiltradas = todasLasPolizas;
            if (filtro === 'activas') {
                polizasFiltradas = todasLasPolizas.filter(p => p.estado === 'ACTIVA');
            } else if (filtro === 'inactivas') {
                polizasFiltradas = todasLasPolizas.filter(p => p.estado !== 'ACTIVA');
            }

            renderizarPolizas(polizasFiltradas);
        }

        function abrirModalSiniestro(polizaId) {
            document.getElementById('polizaId').value = polizaId;
            document.getElementById('btnEnviarSiniestro').style.display = 'block';
            document.getElementById('analisisResult').classList.add('d-none');
            document.getElementById('formSiniestro').reset();
            new bootstrap.Modal(document.getElementById('siniestroModal')).show();
        }

        async function enviarSiniestro() {
            // ... (existing logic) ...
        }

        async function descargarPDF() {
            try {
                const btn = document.querySelector('button[onclick="descargarPDF()"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generando...';
                btn.disabled = true;

                const res = await fetch(`${API_URL}/reportes/polizas/pdf`, {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });

                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "Vesta_Resumen_Polizas.pdf";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Error al generar el reporte.');
                }
                
                btn.innerHTML = originalText;
                btn.disabled = false;
            } catch (e) {
                console.error("Error downloading PDF", e);
                alert('No se pudo conectar con el servidor.');
            }
        }

        function mostrarError(mensaje) {
            const container = document.getElementById('polizasContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-exclamation-triangle text-danger"></i>
                    <h5>${mensaje}</h5>
                </div>
            `;
        }
    </script>
</body>

</html>